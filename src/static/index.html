<title>Neck Dashboard</title>
<style>
  body {
    font-family: "Helvetica Neue", Arial;
    color: #333;
  }
  table {
    box-sizing: border-box;
    border-collapse: collapse;
    width: 100%;
  }
  td {
    padding: 0.5em 1em;
    border: 1px solid #eee;
  }

  header {
    border: 1px solid #eee;
    background: #fafafa;
    padding: 0.5em 1em;
    margin-bottom: 1em;
  }

  header var {
    font-weight: bold;
    font-style: normal;
  }

  header .activityState {
    float: right;
  }

  header .activityState::before {
    content: "";
    width: 1em;
    height: 1em;
    display: block;
    border-radius: 100%;
  }

  header .activityState.active::before {
    background: green;
  }

  header .activityState.inactive::before {
    background: darkred;
  }

  tr:first-child {
    background: #fafafa;
    font-weight: bold;
  }
</style>
<script type="module">
  import { dataService } from "./dataService.js";

  const renderState = (s) => {
    switch (s) {
      case 0:
        return `<b style="color: gray;">Waiting</b>`;
      case 1:
        return `<b style="color: gray;">Connecting</b>`;
      case 2:
        return `<b style="color: green;">Established</b>`;
      default:
        return `<b style="color: red;">Unknown</b>`;
    }
  };

  const renderTable = async () => {
    const table = document.createElement("table");

    const renderTime = (timestamp) => {
      const el = document.createElement("time");
      let value = () => Math.floor((Date.now() - timestamp) / 1000) + "s";
      el.innerHTML = value();
      let timer = setInterval(() => {
        if (!el.parentNode) return clearInterval(timer);
        el.innerHTML = value();
      }, 100);
      return el;
    };

    const createRow = (data) => {
      const row = table.insertRow();
      row.dataset.id = data.id;
      const cells = Array.from({ length: 6 }, () => row.insertCell());
      row.update = (data) => {
        cells[0].textContent = data.id;
        cells[1].textContent = data.proto;
        cells[2].innerHTML = renderState(data.state);
        cells[3].textContent = data.host;
        cells[4].textContent = data.from;
        cells[5].innerHTML = "";
        cells[5].appendChild(renderTime(data.timestamp));
      };
      row.update(data);
      return row;
    };

    dataService.addEventListener("update", (e) => {
      let list = e.detail;
      let m = new Map(list.map((i) => [String(i.id), i]));
      let { rows } = table;
      for (let i = 1; i < rows.length; i++) {
        let row = rows[i];
        let data = m.get(row.dataset.id);
        if (data) {
          m.delete(row.dataset.id);
          row.update(data);
        } else {
          row.remove();
          i--;
        }
      }
      for (const data of m.values()) {
        createRow(data);
      }
    });

    let row = table.insertRow();
    row.insertCell().textContent = "ID";
    row.insertCell().textContent = "Type";
    row.insertCell().textContent = "State";
    row.insertCell().textContent = "Host";
    row.insertCell().textContent = "From";
    row.insertCell().textContent = "Uptime";
    document.body.append(table);
  };

  const renderHeader = () => {
    let header = document.createElement("header");
    let length = 3;

    const a = Array.from({ length }, (_, index) => {
      if (index) header.appendChild(new Text(", "));
      header.insertAdjacentHTML("beforeEnd", renderState(index));
      header.appendChild(new Text(": "));
      let v = document.createElement("var");
      v.textContent = 0;
      header.appendChild(v);
      return v;
    });

    let activityState = document.createElement("div");
    activityState.className = "activityState";
    header.appendChild(activityState);
    dataService.addEventListener("active", (e) => {
      activityState.classList.add("active");
      activityState.classList.remove("inactive");
    });

    dataService.addEventListener("inactive", (e) => {
      activityState.classList.remove("active");
      activityState.classList.add("inactive");
    });

    dataService.addEventListener("update", (e) => {
      const { detail } = e;
      let map = Array(length).fill(0);
      detail.forEach((i) => map[i.state]++);
      map.forEach((v, i) => {
        a[i].innerHTML = v;
      });
    });

    document.body.append(header);
  };

  const main = async () => {
    renderHeader();
    renderTable();
  };

  document.body ? main() : addEventListener("load", main);
</script>
